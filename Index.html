<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Kontrakan Resbal</title>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1/css/pico.min.css">
    <style>
        body { padding-bottom: 5rem; }
        .expense-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: var(--border-radius); }
        .expense-item:nth-child(odd) { background-color: var(--card-background-color); }
        .expense-item img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; cursor: pointer; }
        .expense-details .amount { font-weight: bold; font-size: 1.2rem; }
        .expense-details .meta { font-size: 0.9rem; color: var(--muted-color); }
        #participants-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        #debt-summary { text-align: center; }
    </style>
</head>
<body>
    <nav class="container-fluid">
        <ul>
            <li><strong>Kontrakan Resbal ðŸ’¸</strong></li>
        </ul>
        <ul>
            <li><a href="#" role="button" id="logout-button">Logout</a></li>
        </ul>
    </nav>

    <main class="container">
        <hgroup>
            <h2>Selamat Datang, <span id="user-email">[memuat...]</span>!</h2>
            <p>Catat pengeluaran bersama di sini.</p>
        </hgroup>
        
        <article id="debt-summary">
            <h4>Ringkasan Keuanganmu</h4>
            <p id="debt-status"><progress></progress></p>
        </article>

        <article>
            <form id="expense-form">
                <h3 style="margin-bottom: 1.5rem;">Tambah Pengeluaran Baru</h3>
                <div class="grid">
                    <input type="text" id="description" placeholder="Beli apa? (contoh: Gas + Galon)" required>
                    <input type="number" id="amount" placeholder="Total harga (contoh: 50000)" required>
                </div>
                <label for="photo">Foto Bukti/Struk (Wajib)</label>
                <input type="file" id="photo" accept="image/*" required>
                
                <label>Siapa Saja yang Ikut Patungan?</label>
                <fieldset id="participants-section">
                    <progress></progress>
                </fieldset>
                
                <button type="submit" id="submit-button" aria-busy="false">Simpan</button>
            </form>
        </article>

        <h2 style="margin-top: 2rem;">Daftar Pengeluaran</h2>
        <div id="expense-list">
            <progress></progress>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

    <script>
        // =================================================================================
        // BAGIAN 1: INISIALISASI VARIABEL (HARUS SELALU DI ATAS)
        // =================================================================================
        const SUPABASE_URL = 'https://mewreafpeuawlnaworov.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ld3JlYWZwZXVhd2xuYXdvcm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzgyNTQsImV4cCI6MjA3MDExNDI1NH0.R7sdHt7Ry3jt4kIaMH-IXnBUUzteA2Bvw4Eq8ZhncEo';
        
        // Initialize supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);        let currentUser = null;
        const userEmailEl = document.getElementById('user-email');
        const expenseListEl = document.getElementById('expense-list');
        const participantsSection = document.getElementById('participants-section');
        const debtStatusEl = document.getElementById('debt-status');
        const debtSummaryEl = document.getElementById('debt-summary');

        // =================================================================================
        // BAGIAN 2: DEFINISI SEMUA FUNGSI
        // =================================================================================
        
        async function fetchAndDisplayUsers() {
            const { data: profiles, error } = await supabase.from('profiles').select('id, username');
            if (error) {
                participantsSection.innerHTML = '<p style="color:red;">Gagal memuat daftar teman.</p>';
                return;
            }
            participantsSection.innerHTML = '';
            profiles.forEach(profile => {
                if (profile.id !== currentUser.id) {
                    participantsSection.innerHTML += `
                        <label for="user-${profile.id}">
                            <input type="checkbox" id="user-${profile.id}" name="participant" value="${profile.id}">
                            ${profile.username || 'User Tanpa Nama'}
                        </label>`;
                }
            });
        }

        async function fetchExpenses() {
            expenseListEl.innerHTML = '<progress></progress>';
            const { data: expenses, error } = await supabase.from('expenses').select(`*, profiles(username)`).order('created_at', { ascending: false });

            if (error) {
                expenseListEl.innerHTML = `<p style="color:red;">Gagal memuat data.</p>`;
                return;
            }
            if (expenses.length === 0) {
                expenseListEl.innerHTML = `<p>Belum ada pengeluaran yang dicatat.</p>`;
                return;
            }
            expenseListEl.innerHTML = '';
            expenses.forEach(expense => {
                const expenseDate = new Date(expense.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'long' });
                const item = document.createElement('article');
                item.className = 'expense-item';
                item.innerHTML = `
                    <img src="${expense.photo_url}" alt="${expense.description}" onclick="window.open('${expense.photo_url}', '_blank')">
                    <div class="expense-details">
                        <p class="amount">Rp ${new Intl.NumberFormat('id-ID').format(expense.amount)}</p>
                        <p>${expense.description}</p>
                        <p class="meta">Oleh: <strong>${expense.profiles ? expense.profiles.username : '...'}</strong> pada ${expenseDate}</p>
                    </div>`;
                expenseListEl.appendChild(item);
            });
        }

        async function calculateAndDisplayDebt() {
            debtStatusEl.innerHTML = 'Menghitung... <progress></progress>';
            
            try {
                // Get simpler data - all expense participants for current user
                const { data: userParticipants, error: participantsError } = await supabase
                    .from('expense_participants')
                    .select('expense_id, participant_id, amount_owed')
                    .eq('participant_id', currentUser.id);

                if (participantsError) {
                    console.error('Error fetching participants:', participantsError);
                    debtStatusEl.innerHTML = 'Error memuat data hutang';
                    return;
                }

                // Get all expenses where current user is the payer
                const { data: userExpenses, error: expensesError } = await supabase
                    .from('expenses')
                    .select('id, payer_id, amount')
                    .eq('payer_id', currentUser.id);

                if (expensesError) {
                    console.error('Error fetching expenses:', expensesError);
                    debtStatusEl.innerHTML = 'Error memuat data pengeluaran';
                    return;
                }

                // Get all participants for expenses where current user is payer
                const expenseIds = userExpenses?.map(e => e.id) || [];
                const { data: allParticipants, error: allParticipantsError } = await supabase
                    .from('expense_participants')
                    .select('expense_id, participant_id, amount_owed')
                    .in('expense_id', expenseIds);

                if (allParticipantsError) {
                    console.error('Error fetching all participants:', allParticipantsError);
                }

                // Get all user profiles for username mapping
                const { data: profiles, error: profilesError } = await supabase
                    .from('profiles')
                    .select('id, username');

                if (profilesError) {
                    console.error('Error fetching profiles:', profilesError);
                }

                const profileMap = {};
                profiles?.forEach(profile => {
                    profileMap[profile.id] = profile.username;
                });

                // Calculate individual balances
                const balances = {};

                // Money owed TO current user (from expenses current user paid)
                allParticipants?.forEach(participant => {
                    if (participant.participant_id !== currentUser.id) {
                        const otherId = participant.participant_id;
                        if (!balances[otherId]) balances[otherId] = 0;
                        balances[otherId] += participant.amount_owed; // Others owe current user
                    }
                });

                // Money current user OWES (from expenses others paid)
                userParticipants?.forEach(participant => {
                    // Find the expense to get who paid
                    const expense = userExpenses?.find(e => e.id === participant.expense_id);
                    if (!expense) {
                        // This expense was paid by someone else, current user owes them
                        // We need to find who paid - let's get it separately
                        // For now, we'll handle this in a simpler way
                    }
                });

                // Get expenses where current user is participant but not payer
                const { data: otherExpenses, error: otherExpensesError } = await supabase
                    .from('expense_participants')
                    .select(`
                        expense_id,
                        amount_owed,
                        expenses!inner(payer_id)
                    `)
                    .eq('participant_id', currentUser.id)
                    .neq('expenses.payer_id', currentUser.id);

                otherExpenses?.forEach(item => {
                    const payerId = item.expenses.payer_id;
                    if (!balances[payerId]) balances[payerId] = 0;
                    balances[payerId] -= item.amount_owed; // Current user owes this person
                });

                displayIndividualBalances(balances, profileMap);
                
            } catch (error) {
                console.error('Error calculating debts:', error);
                debtStatusEl.innerHTML = 'Error menghitung hutang';
            }
        }

        function displayIndividualBalances(balances, profileMap) {
            let html = '';
            let netBalance = 0;
            
            const youOwe = [];
            const youAreOwed = [];
            
            Object.entries(balances).forEach(([userId, amount]) => {
                const username = profileMap[userId] || 'Unknown User';
                
                if (amount > 0) {
                    // You are owed money
                    youAreOwed.push({ username, amount });
                    netBalance += amount;
                } else if (amount < 0) {
                    // You owe money
                    youOwe.push({ username, amount: Math.abs(amount) });
                    netBalance += amount;
                }
            });

            // Display individual balances
            if (youOwe.length > 0) {
                html += '<div style="margin-bottom: 1rem;"><strong>ðŸ”´ Kamu berhutang:</strong><ul>';
                youOwe.forEach(debt => {
                    html += `<li>Rp ${new Intl.NumberFormat('id-ID').format(debt.amount)} ke <strong>${debt.username}</strong></li>`;
                });
                html += '</ul></div>';
            }

            if (youAreOwed.length > 0) {
                html += '<div style="margin-bottom: 1rem;"><strong>ðŸŸ¢ Kamu akan menerima:</strong><ul>';
                youAreOwed.forEach(credit => {
                    html += `<li>Rp ${new Intl.NumberFormat('id-ID').format(credit.amount)} dari <strong>${credit.username}</strong></li>`;
                });
                html += '</ul></div>';
            }

            if (youOwe.length === 0 && youAreOwed.length === 0) {
                html = 'ðŸŽ‰ Keren! Tidak ada hutang piutang.';
                debtSummaryEl.style.backgroundColor = 'var(--card-background-color)';
                debtSummaryEl.style.color = 'var(--pico-color)';
            } else {
                // Net balance
                html += '<hr><div style="text-align: center; font-weight: bold;">';
                if (netBalance > 0) {
                    html += `<span style="color: green;">Net: Kamu akan menerima Rp ${new Intl.NumberFormat('id-ID').format(netBalance)}</span>`;
                    debtSummaryEl.style.backgroundColor = 'var(--pico-color-green-200)';
                    debtSummaryEl.style.color = 'var(--pico-color-green-700)';
                } else if (netBalance < 0) {
                    html += `<span style="color: red;">Net: Kamu berhutang Rp ${new Intl.NumberFormat('id-ID').format(Math.abs(netBalance))}</span>`;
                    debtSummaryEl.style.backgroundColor = 'var(--pico-color-red-200)';
                    debtSummaryEl.style.color = 'var(--pico-color-red-700)';
                } else {
                    html += '<span>Net: Impas</span>';
                    debtSummaryEl.style.backgroundColor = 'var(--card-background-color)';
                    debtSummaryEl.style.color = 'var(--pico-color)';
                }
                html += '</div>';
            }

            debtStatusEl.innerHTML = html;
        }
        
        // =================================================================================
        // BAGIAN 3: EKSEKUSI & EVENT LISTENERS (HARUS DI PALING BAWAH)
        // =================================================================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = "/login.html";
            } else {
                currentUser = user;
                userEmailEl.textContent = user.email;
                await Promise.all([ fetchExpenses(), fetchAndDisplayUsers(), calculateAndDisplayDebt() ]);
            }
        });

        document.getElementById('logout-button').addEventListener('click', async (e) => {
            e.preventDefault();
            console.log('Logout clicked'); // Debug
            
            try {
                await supabase.auth.signOut();
                console.log('Signed out successfully'); // Debug
                window.location.href = "/login.html";
            } catch (error) {
                console.error('Logout error:', error);
                // Paksa redirect meskipun ada error
                window.location.href = "/login.html";
            }
        });

        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('submit-button');
            submitButton.setAttribute('aria-busy', 'true');
            submitButton.disabled = true;

            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const photoFile = document.getElementById('photo').files[0];
            const checkedBoxes = document.querySelectorAll('input[name="participant"]:checked');
            const participantIds = Array.from(checkedBoxes).map(cb => cb.value);
            participantIds.push(currentUser.id);
            
            const totalParticipants = participantIds.length;
            if (totalParticipants === 1 && participantIds[0] === currentUser.id) {
                 alert("Pilih minimal satu teman untuk diajak patungan!");
                 submitButton.setAttribute('aria-busy', 'false');
                 submitButton.disabled = false;
                 return;
            }

            try {
                const options = { maxSizeMB: 0.5, maxWidthOrHeight: 800 };
                const compressedFile = await imageCompression(photoFile, options);
                const filePath = `${currentUser.id}/${Date.now()}-${compressedFile.name}`;
                await supabase.storage.from('receipts').upload(filePath, compressedFile);
                const { data: urlData } = supabase.storage.from('receipts').getPublicUrl(filePath);

                const { data: newExpense, error: expenseError } = await supabase.from('expenses').insert({ description, amount, photo_url: urlData.publicUrl, payer_id: currentUser.id }).select().single();
                if (expenseError) throw expenseError;
                
                const amountPerPerson = amount / totalParticipants;
                const participantsData = participantIds.map(id => ({ expense_id: newExpense.id, participant_id: id, amount_owed: amountPerPerson }));
                const { error: participantsError } = await supabase.from('expense_participants').insert(participantsData);
                if (participantsError) throw participantsError;
                
                // ...existing code...
                document.getElementById('expense-form').reset();
                alert('Pengeluaran berhasil disimpan');
                await Promise.all([fetchExpenses(), calculateAndDisplayDebt()]);

            } catch (error) {
                console.error('Error submitting expense:', error);
                alert('Gagal menyimpan pengeluaran: ' + error.message);
            } finally {
                submitButton.setAttribute('aria-busy', 'false');
                submitButton.disabled = false;
            }
        });
    </script>
</body>
</html>
